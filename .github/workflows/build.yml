name: build
on:
  push:
    branches:
      - master
      - dev
  pull_request: {}
  workflow_dispatch: {}
jobs:
  ubuntu:
    runs-on: ubuntu-latest
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Install dependencies
        run: |
          git submodule update --init --recursive
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libavcodec-dev \
            libavdevice-dev \
            libavfilter-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libvulkan-dev \
            glslang-tools
      - name: Build Video2X
        run: |
          mkdir -p /tmp/build /tmp/install
          cmake -B /tmp/build -S . -DUSE_SYSTEM_NCNN=OFF \
            -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/tmp/install
          cmake --build /tmp/build --config Release --target install --parallel
      - name: Package artifacts
        run: |
          tar cJvf /tmp/video2x-nightly.txz -C /tmp/install .
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: video2x-nightly
          path: /tmp/video2x-nightly.txz
